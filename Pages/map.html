<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marine Mammal Stranding System</title>
    <script src="https://kit.fontawesome.com/a88b731ad6.js" crossorigin="anonymous"></script>
    <script src="../Scripts/login.js"></script>
    <link rel="stylesheet" href="../Styles/style.css" type="text/css">
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.css' rel='stylesheet' />
</head>
<!--<body onload="authenticateSession()">-->
<body>
<header id="headerBar">
    <div id="right-header">
        <nav id="menu">
            <a href="home.html">Home</a>
            <a href="map.html" style="color: dodgerblue">Map</a>
            <a href="report.html">Report Stranding</a>
            <a href="organization.html">Organization</a>
            <a href="search.html">Strandings</a>
            <a>Logout</a>
        </nav>
    </div>
</header>

<div id='map' style='width: 100%; height: 600px;'></div>
<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoianJ0MjI1IiwiYSI6ImNqcWJzMGVvcjA2Nng0MnFvNHIwdnc5YnYifQ.OZxuEOysWuDEmYUAWdTELA';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/outdoors-v11'
    });

    // Add geolocate control to the map.
    const geolocate = new mapboxgl.GeolocateControl({
        positionOptions: {
            enableHighAccuracy: true
        },
        trackUserLocation: true
    });

    map.addControl(geolocate);

    map.on('load', function()
    {
        geolocate.trigger();
    });

    map.on('load', function() {
        map.loadImage(
            'https://img.icons8.com/material/24/000000/marker--v1.png',
            function(error, image) {
                if (error) throw error;
                map.addImage('map-icon', image);

                let locationURL = "http://localhost:39999/get-stranding-locations";
                let getResponders = new XMLHttpRequest();

                getResponders.open("GET", locationURL, true);
                getResponders.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

                getResponders.addEventListener('load', function () {
                    if (getResponders.status >= 200 && getResponders.status < 400) {
                        let getResponse = JSON.parse(getResponders.responseText);

                        for (let idx = 0; idx < getResponse.length; idx++) {
                            map.addSource('point', {
                                'type': 'geojson',
                                'data': {
                                    'type': 'FeatureCollection',
                                    'features': [
                                        {
                                            'type': 'Feature',
                                            'geometry': {
                                                'type': 'Point',
                                                'coordinates': [getResponse[idx].longitude, getResponse[idx].latitude]
                                            }
                                        }
                                    ]
                                }
                            });

                            map.addLayer({
                                'id': 'points',
                                'type': 'symbol',
                                'source': 'point',
                                'layout': {
                                    'icon-image': 'map-icon',
                                    'icon-size': 0.75
                                }
                            });
                        }
                    }
                });

                getResponders.send();

                event.preventDefault();

            }
        )
    });

</script>

<button id="report-button">Report Stranding at Location</button>
<script src="../Scripts/strandingReport.js"></script>

<script>
    document.getElementById('report-button').addEventListener('click', reportStranding);
</script>
</body>
</html>